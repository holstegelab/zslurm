#!/usr/bin/env python
import zslurm_shared
import socket
try: 
    import http.client as httplib
except:
    import httplib
import argparse
import sys
import traceback

parser = argparse.ArgumentParser(description='ZSlurm node listing')
parser.add_argument('--all', action='store_true', help='Show also queued nodes.')
parser.add_argument('--parseable', action='store_true', help='Output TSV table suitable for parsing.')
parser.add_argument('--instance', action='append', metavar='NAME', help='Filter to a specific instance (can be given multiple times).')
args = parser.parse_args()
def _get_instances_from_args():
    if args.instance:
        return args.instance
    try:
        return zslurm_shared.get_instance_names()
    except Exception:
        traceback.print_exc()
        sys.stderr.write("Failed to enumerate instances; falling back to default instance.\n")
        return [zslurm_shared.DEFAULT_INSTANCE_NAME]


def _fetch_nodes(instance):
    url = None
    try:
        url = zslurm_shared.get_job_url(instance=instance)
        proxy = zslurm_shared.TimeoutServerProxy(url, allow_none=True)
        return proxy.list_nodes()
    except (socket.error, httplib.HTTPException) as ex:
        if url is None:
            url = "<unresolved>"
        sys.stderr.write(f"{instance}: failed to connect to ZSlurm manager at {url}: {ex}\n")
        traceback.print_exc()
    except KeyError:
        sys.stderr.write(f"Instance '{instance}' not defined in configuration.\n")
    except Exception as ex:
        sys.stderr.write(f"{instance}: unexpected error while fetching nodes: {ex}\n")
        traceback.print_exc()
    return []


instances = _get_instances_from_args()
use_pretty = not args.parseable
tabulate_module = None
if use_pretty:
    try:
        import tabulate as tabulate_module
    except Exception:
        traceback.print_exc()
        sys.stderr.write("Pretty formatting unavailable; falling back to TSV output. Use --parseable to suppress this message.\n")
        use_pretty = False

if args.parseable:
    header = [
        "INSTANCE","ID","SLURM","PARTITION","CORES","MEM","TIME","REMAINING","NJOBS",
        "CPU","MEM","LOAD","SYSCPU","IOWAIT","RESCPU","RESMEM","SSD","SSD_TOTAL","SSD_USED","SSD_RSVD","STATUS"
    ]
    print("\t".join(header))

for instance in instances:
    nodes = _fetch_nodes(instance)    

    if args.parseable:
        for node in nodes:
            partition, engine_id, cluster_id, cores, totmem, runtime, timeleft, njobs, cpu_usage, mem_usage, load, status = node[:12]
            sys_cpu_busy = node[12] if len(node) > 12 else 0.0
            sys_iowait = node[13] if len(node) > 13 else 0.0
            res_cpu = node[14] if len(node) > 14 else 0.0
            res_mem_mb = node[15] if len(node) > 15 else 0.0
            has_ssd = bool(node[16]) if len(node) > 16 else False
            ssd_total_gb = node[17] if len(node) > 17 else 0.0
            ssd_used_gb = node[18] if len(node) > 18 else 0.0
            res_ssd_reserved_gb = node[19] if len(node) > 19 else 0.0
            runtime_fmt = zslurm_shared.format_time(runtime)
            timeleft_fmt = zslurm_shared.format_time(timeleft)
            row = [
                instance,
                engine_id,
                cluster_id,
                partition,
                f"{cores:.0f}",
                f"{totmem/1024.0:.1f}Gb",
                runtime_fmt,
                timeleft_fmt,
                str(njobs),
                f"{cpu_usage:.1f}",
                f"{mem_usage:.1f}",
                f"{load:.1f}",
                f"{sys_cpu_busy:.1f}",
                f"{sys_iowait:.1f}",
                f"{res_cpu:.1f}",
                f"{res_mem_mb/1024.0:.1f}Gb",
                'Y' if has_ssd else 'N',
                f"{ssd_total_gb:.1f}Gb",
                f"{ssd_used_gb:.1f}Gb",
                f"{res_ssd_reserved_gb:.1f}Gb",
                status,
            ]
            print("\t".join(row))
        continue

    if use_pretty and tabulate_module is not None:
        table = []
        for node in nodes:
            partition, engine_id, cluster_id, cores, totmem, runtime, timeleft, njobs, cpu_usage, mem_usage, load, status = node[:12]
            sys_cpu_busy = node[12] if len(node) > 12 else 0.0
            sys_iowait = node[13] if len(node) > 13 else 0.0
            res_cpu = node[14] if len(node) > 14 else 0.0
            res_mem_mb = node[15] if len(node) > 15 else 0.0
            has_ssd = bool(node[16]) if len(node) > 16 else False
            ssd_total_gb = node[17] if len(node) > 17 else 0.0
            ssd_used_gb = node[18] if len(node) > 18 else 0.0
            res_ssd_reserved_gb = node[19] if len(node) > 19 else 0.0
            runtime_fmt = zslurm_shared.format_time(runtime)
            timeleft_fmt = zslurm_shared.format_time(timeleft)
            table.append([
                engine_id, cluster_id, partition,
                f"{cores:.0f}", f"{totmem/1024.0:.1f}Gb",
                runtime_fmt, timeleft_fmt, njobs,
                f"{cpu_usage:.1f}", f"{mem_usage:.1f}", f"{load:.1f}",
                f"{sys_cpu_busy:.1f}", f"{sys_iowait:.1f}",
                f"{res_cpu:.1f}", f"{res_mem_mb/1024.0:.1f}Gb",
                'Y' if has_ssd else 'N', f"{ssd_total_gb:.1f}Gb", f"{ssd_used_gb:.1f}Gb", f"{res_ssd_reserved_gb:.1f}Gb",
                status
            ])
        if len(instances) > 1:
            print(f"Instance: {instance}")
        
        print(tabulate_module.tabulate(table, headers=['ID','SLURM','PARTITION','CORES','MEM','TIME','REMAINING','NJOBS','CPU','MEM','LOAD','SYSCPU','IOWAIT','RESCPU','RESMEM','SSD','SSD_TOTAL','SSD_USED','SSD_RSVD','STATUS']))
        
        if len(instances) > 1:
            print()
    else:
        if len(instances) > 1:
            print(f"Instance: {instance}")
        print("ID\tSLURM\tPARTITION\tCORES\tMEM\tTIME\tREMAINING\tNJOBS\tCPU\tMEM\tLOAD\tSYSCPU\tIOWAIT\tRESCPU\tRESMEM\tSSD\tSSD_TOTAL\tSSD_USED\tSSD_RSVD\tSTATUS")
        for node in nodes:
            partition, engine_id, cluster_id, cores, totmem, runtime, timeleft, njobs, cpu_usage, mem_usage, load, status = node[:12]
            sys_cpu_busy = node[12] if len(node) > 12 else 0.0
            sys_iowait = node[13] if len(node) > 13 else 0.0
            res_cpu = node[14] if len(node) > 14 else 0.0
            res_mem_mb = node[15] if len(node) > 15 else 0.0
            has_ssd = bool(node[16]) if len(node) > 16 else False
            ssd_total_gb = node[17] if len(node) > 17 else 0.0
            ssd_used_gb = node[18] if len(node) > 18 else 0.0
            res_ssd_reserved_gb = node[19] if len(node) > 19 else 0.0
            runtime_fmt = zslurm_shared.format_time(runtime)
            timeleft_fmt = zslurm_shared.format_time(timeleft)
            print('%s\t%s\t%s\t%.2g\t%.1fGb\t%s\t%s\t%d\t%.1f\t%.1f\t%.1f\t%.1f\t%.1f\t%.1f\t%.1fGb\t%s\t%.1fGb\t%.1fGb\t%.1fGb\t%s' % (
                engine_id, cluster_id, partition, cores, totmem/1024.0, runtime_fmt, timeleft_fmt, njobs,
                cpu_usage, mem_usage, load, sys_cpu_busy, sys_iowait, res_cpu, res_mem_mb/1024.0,
                ('Y' if has_ssd else 'N'), ssd_total_gb, ssd_used_gb, res_ssd_reserved_gb, status))
        if len(instances) > 1:
            print()
